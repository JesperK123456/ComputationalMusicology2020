---
title: "A musical analysis of Rush"
output: 
  flexdashboard::flex_dashboard:
    #orientation: columns
    #vertical_layout: scroll
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load libraries (every time)

library(tidyverse)
library(flexdashboard)
library(spotifyr)
library(dplyr)
library(ggplot2)
library(reshape2)
library(dbscan)
library(factoextra)
library(plotly)
library(compmus)

# Set Spotify access variables (every time)
rm(list = ls())

load("Corpus.RData")
load("spotify_env.RData")

set_spotify_ID()
```

Introduction
===

Column
---

### The Canadian Rock, Metal and What Have You band
The Canadian band [Rush](https://bit.ly/2HkT2Sx) is at its heart a rock band. However, during the extensive lifetime of Rush, its music found a lot of influence from a wide scope of genres and music styles. With a lifespan of more than 40 years and a total of 19 studio albums, a lot has changed from begin to end. 
In this portfolio, I will try to analyze the way Rush's music changed over the years, and I will try to determine different style periods accross its albums. Furthermore, I will look at how different genres apply to different eras of Rush. 

Column
---

### The Corpora 
Of course, the most important corpus I will use is that containing the audio features of the entire discography of Rush itself. Upon initial inspection, I decided to remove the album "2112 - 40 Years Closer: A Q&A With Alex Lifeson And Terry Brown Commentary" as it contains commentary and is thus not relevant to my analysis. 
Furthermore, I looked at different genres that are said to be part of at least some era of Rush. For each of these genres I collected the audio features of a playlist that seemed most representative for that genre. I chose playlists of the following genres:

 * Rock:
    + 70s Rock Anthems
    + 80s Rock Anthems
    + 90s Rock Anthems
    + 00s Rock Anthems
 * Progressive Rock (user-made playlist)
 * Pop Rock (Pop Rock Shot)
 * Reggae (Reggae Classics)
 * New Wave (Is it New Wave?)
 * Jazz (Jazz Classics)
 * Metal (Metal Essentials)
 * Symphonic Metal (user-made playlist)
 
I chose a total of four playlists for the Rock genre, so that I can analyse whether Rush followed the general trend of rock music through the years. 

Album Classification {.storyboard}
===

### First, I performed an initial analysis of the basic features of the studio albums
```{r plot, include=TRUE, fig.align="center"}
plot <-
rush_features_by_album %>% 
  filter(is_studio) %>% 
    ggplot(aes(x=studioalbum_idx)) +
      geom_line(aes(y=danceability, colour="danceability")) + 
      geom_line(aes(y=energy, colour="energy")) + 
      geom_line(aes(y=speechiness, colour="speechiness")) + 
      geom_line(aes(y=acousticness, colour="acousticness")) + 
      geom_line(aes(y=instrumentalness, colour="instrumentalness")) + 
      geom_line(aes(y=liveness, colour="liveness")) + 
      geom_line(aes(y=valence, colour="valence")) + 
      scale_x_continuous(
        name="Studio album idx",
        breaks=c(1:length(rush_studioalbum_idx)), 
        labels=c(1:length(rush_studioalbum_idx)),
        limits=c(1,20)) +
      scale_y_continuous(
        name="Value",
        breaks=c(0:10)/10, 
        labels=c(0:10)/10,
        limits=c(0,1)) +
      ggtitle("Mean of music features per studio album") +
      labs(color="Property")

ggplotly(plot)
```

***

I analyzed the audio features of each studio album of Rush, to see whether there are some easily spottable trends in there. The studio albums are, in order of release date:

1. Rush (1974)
2. Fly By Night (1975)
3. Caress of Steel (1975)
4. 2112 (1976)
5. A Farewell to Kings (1977)
6. Hemispheres (1978)
7. Permanent Waves (1980)
8. Moving Pictures (1981)
9. Signals (1982)
10. Grace Under Pressure (1984)
11. Power Windows (1985)
12. Hold Your Fire (1987)
13. Presto (1989)
14. Roll The Bones (1991)
15. Counterparts (1993)
16. Test For Echo (1997)
17. Vapor Trails (2002)
19. Snakes & Arrows (2007)
20. Clockwork Angels (2012)

This initial plot looks promising; we can see at least the _energy_, _valence_ and _danceability_ following some kind of a pattern here. Interestingly, we can see a dip in _energy_ and a peak in both _danceability_ and _valence_ at the 13th studio album. It seems like Rush tried to do something different in that album. This could indeed be what happened, as this album - Presto - wasn't received very well by the general public. It seems Rush learned from this, as, according to my plot, they seem to return to their 'roots' in their later albums. 

### These features proved promising; so I proceded to do a principal component analysis of all Rush' albums.

```{r liveclassification, fig.width = 9}
rush_features_by_album$album_type <- "Live"
rush_features_by_album$album_type[rush_studioalbum_idx] <- "Studio"
rush_features_by_album$album_type[c(18, 25, 29)] <- "Compilation"
rush_albums_pca <- prcomp(rush_features_by_album[c(10:16)])
rush_album_names <- factor(rush_features_by_album$album_name, levels=rush_features_by_album$album_name)
ggplot(mapping=aes(x=rush_album_names, y=rush_albums_pca$x[,1], fill=rush_features_by_album$album_type)) + 
  geom_col() + 
  xlab("Album name") + 
  ylab("First principal component value") + 
  ggtitle("Principal Component Analysis of all Rush' albums") +
  labs(fill="Album type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

***

The results as shown before implies that there is a good chance the these music features could be enough to give an initial classification between Rush albums. To be able to easily incoroporate all these features in my classification, I used a principal component analysis to further explore the data. A principal component analysis reduces the dimensionality of a dataset (my initial dataset is in this case 8-dimensional) by breaking it down into multiple principal components, where the first principal component captures most information (information from all dimensions of the initial set!). Each next principal component captures less and less information.
Firstly, I analyzed all albums of Rush. This graph represents the values of the first (i.e. most informative) principal component plotted against album.

We can see that this principal component classifies all live-albums of Rush perfectly. However, as the first principal compment captures the most information of the entire dataset, I will now perform another PCA on only the studio albums for more accurate comparison.

### This proved to be effective to classify studio albums vs. live albums, so I now did a PCA on only Rush' studio albums.

```{r studio_pca, fig.width = 9}
rush_features_by_stalbum <- rush_features_by_album %>% filter(is_studio)
rush_stalbums_pca <- prcomp(rush_features_by_stalbum[c(10:16)])
rush_stalbums_pc <- data.frame(rush_stalbums_pca$x)


rush_stalbums_pc$album_name <- rush_features_by_stalbum$album_name
rush_stalbums_pc$album_idx <- c(1:nrow(rush_stalbums_pc))

rush_stalbums_pc.m <- melt(rush_stalbums_pc, id.vars= c("album_idx", "album_name"), measure.vars=c("PC1", "PC2", "PC3", "PC4"))

rush_stalbum_names <- factor(rush_stalbums_pc$album_name, levels=rush_stalbums_pc$album_name)

#ggplot(rush_stalbums_pc, aes(x=PC1, y=PC2, colour=as.character(cluster), size=4)) + geom_point()

ggplot(rush_stalbums_pc.m, 
       aes(x=reorder(album_name, album_idx),
           y=value,
           fill=variable)) +
  geom_bar(stat="identity") +
  facet_wrap(~ variable, ncol=2) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position="none") +
  ylab("Principal Component value") +
  xlab("Studio Album") +
  ggtitle("Principal Component Analysis of Rush' studio albums")
```

***

Looking at the first four principal components we can see that indeed the first one captures the most radical changes across albums. Furthermore, it looks like these principal components divide Rush' discography up in about 5 different eras. The next step will be to perform an actual clustering of these data and evaluate whether we need any more data to cluster the studio albums

### Distance matrix to find location of starting centroids for k-means

```{r matrix}
row.names(rush_stalbums_pc) <- rush_stalbums_pc$album_name

fviz_dist(
  get_dist(
    rush_stalbums_pc[,c(1:7)], 
    method="pearson"), 
  order=TRUE, 
  gradient = list(low = "green", mid="black", high = "red")
  ) + 
ggtitle("Distance matrix of Rush albums (pearson distance metric)")
```

***

This beatiful QR-like visualizations shows the distance (or invertedly the similarity) between different albums, based on the principal components. For an X and Y-coordinate, the color of the square leading to them represents the distance between these albums. The greener the square is, the closer they are.

It is intereseting to see that, according to this matrix, the albums Presto and Rush are outliers relative to the rest of Rush' discography. This is to be expected, as we saw earlier that Presto was different. Furthermore, the album Rush is Rush' first album, and at that time the band had another drummer. As the drummer that came after this album influenced the musical style of the albums to come, it is not surprising that the album Rush is different.

To give the k-means clustering algorithm the best change of succeeding, I want to initiate the centroids (center of a cluster) somewhere close to the eventual clusters. I can use the distance matrix for this. It would be best to place the centroids somewhere in the middle of a green 'blob'. The bigger the blob, the higher is the chance a cluster will converge to it anyways. I therefore decided to locate my initial centroids at the albums "Signals", "Counterparts", "Power Windows", "Caress of Steel" and "A Farewell To kings".

### Clustering the studio albums with k-means 

```{r cluster, echo=FALSE}
row.names(rush_stalbums_pc) <- rush_stalbums_pc$album_name

#rush_stalbums_pc.cluster <- kmeans(rush_stalbums_pca$x[,c(1:7)], centers=rush_stalbums_pc[c("Signals", "Caress Of Steel", "A Farewell To Kings", "Counterparts", "Power Windows"),c(1:7)])

rush_stalbums_pc.cluster <-
  kmeans(
    rush_features_by_album[rush_features_by_album$is_studio,c(10:16)],
    centers = rush_features_by_album[c(3,6,12,14,20),c(10:16)]
  )

plt <- fviz_cluster(rush_stalbums_pc.cluster, data=rush_stalbums_pc[,-c(8)])
plotly_build(plt)
```

***

These are the clusters produced with the k-means clustering algorithm. Regarding the labels that are clipping, I had to include them as otherwise you can't see what point represents what album (also on hover). You can remove labels by clicking once on the corresponding [Aa (x,x,NA)] entry in the legend. Unfortunately, plotly doesn't support removing labels beforehand with this cluster plot.

At first hand, the clusters seem surprising. For instance, it looks like Power Windows is way closer to Moving Pictures from another cluster that it is to Hold Your Fire or Clockwork Angels, the albums it shares a cluster with. However this is not neccesarily the case as the two dimiensions that are plotted here are only able to reflect 22% and 12% of the information. The cluster algorithm however, uses 100% of the information. Imagine the z-axis pointing upwards from the screen. These clusters could then be explained by the fact that the points from cluster 4 lay way higher on the z-axis than the points in cluster 3. 

### Album clustering: Conclusion
```{r clusters}
rush_albums_clustered <- rush_stalbums_pc %>% 
  select(album_name, album_idx) %>% 
  mutate(cluster = rush_stalbums_pc.cluster$cluster)

rownames(rush_albums_clustered) <- rush_albums_clustered$album_name

rush_clustered <- rush %>% filter(is_studio)

clustercol <- c()
for(i in 1:nrow(rush_clustered)){
  clustercol[i] <- rush_albums_clustered[rush_clustered[i,]$album_name,]$cluster
}

rush_clustered$cluster <- clustercol

#smol <- rush_clustered %>% 
#  group_by(album_name) %>% 
#  slice(1) %>% 
#  rename(track.uri = track_uri) %>% 
#  add_audio_analysis() %>% 
#  ungroup() %>% 
#  arrange(cluster)


rush.ca <- rush_clustered %>% 
  rename(track.uri = track_uri) %>% 
  add_audio_analysis()%>% 
  arrange(cluster)

knitr::kable(
  rush_albums_clustered %>% 
    group_by(album_name) %>% 
    arrange(cluster) %>% 
    select("Album name" = album_name, "Cluster" = cluster, "Release order" = album_idx) 
)
```

***

Here, we can see the cluster sets that came from my clustering. As the cluster visualization from the previous page only offers a limited view of the performance of my clustering, I will now look at timbral and chordal analyses to see whether the clustering seems any good and, if so, whether I can spot distinctive properties of different clusters.

### (SUBJECT TO CHANGE) Comparing typical songs from all clusters to each other

```{r timbreetc, echo=FALSE, eval=TRUE}
songs <- c(
  '4Ilt9N2XASXY60DSEitW5K', #AFTK
  '2P0x26YpGzXDddtQEc171e', #Marathon
  '1gkn90ExKRNAOlhDs4RoW0', #Working Man
  '341PPpWkAUkEQeIdQQDGTo', #Jacob's Ladder
  '0Z0s6dw0zw2ENU1gVjlLV6'  #Subdivisions
)

names <- c(
  'A Farewell To Kings',
  'Marathon',
  'Working Man',
  "Jacob's Ladder",
  'Subdivisions'
)

get <- function(id){
  res <-
    get_tidy_audio_analysis(id) %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'rms', norm = 'euclidean'))
  return(res)
}

get_ssm <- function(data){
  data %>% 
    compmus_self_similarity(timbre, 'cosine') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '')
}

matrices <- c()

data <- get(songs[1])
  data %>% 
  compmus_self_similarity(timbre, 'cosine') %>% 
  ggplot(
      aes(
          x = xstart + xduration / 2, 
          width = xduration,
          y = ystart + yduration / 2,
          height = yduration,
          fill = d)) + 
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(option = 'E') +
  theme_classic() +
  labs(x = '', y = '') + 
  ggtitle(names[1])
  
data <- get(songs[2])
  data %>% 
  compmus_self_similarity(timbre, 'cosine') %>% 
  ggplot(
      aes(
          x = xstart + xduration / 2, 
          width = xduration,
          y = ystart + yduration / 2,
          height = yduration,
          fill = d)) + 
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(option = 'E') +
  theme_classic() +
  labs(x = '', y = '') + 
  ggtitle(names[2])
  
data <- get(songs[3])
  data %>% 
  compmus_self_similarity(timbre, 'cosine') %>% 
  ggplot(
      aes(
          x = xstart + xduration / 2, 
          width = xduration,
          y = ystart + yduration / 2,
          height = yduration,
          fill = d)) + 
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(option = 'E') +
  theme_classic() +
  labs(x = '', y = '') + 
  ggtitle(names[3])
  
data <- get(songs[4])
  data %>% 
  compmus_self_similarity(timbre, 'cosine') %>% 
  ggplot(
      aes(
          x = xstart + xduration / 2, 
          width = xduration,
          y = ystart + yduration / 2,
          height = yduration,
          fill = d)) + 
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(option = 'E') +
  theme_classic() +
  labs(x = '', y = '') + 
  ggtitle(names[4])
  
data <- get(songs[5])
  data %>% 
  compmus_self_similarity(timbre, 'cosine') %>% 
  ggplot(
      aes(
          x = xstart + xduration / 2, 
          width = xduration,
          y = ystart + yduration / 2,
          height = yduration,
          fill = d)) + 
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(option = 'E') +
  theme_classic() +
  labs(x = '', y = '') + 
  ggtitle(names[5])

``` 

***

I tried to look at what makes each cluster destinctive from the rest, by taking a specific song from all clusters and comparing the self-similarity matrices with each other. These are shown to the left. Unfortunately, even though the individual matrices are very pretty indeed, I couldn't find any distinctive differences between any of the matrices. 


### Comparing timbre features across clusters
```{r, echo=FALSE}
rush.ca %>% 
    mutate(
        timbre =
            map(
                segments,
                compmus_summarise,
                timbre,
                method = 'mean')) %>%
    select(cluster, timbre) %>% 
    compmus_gather_timbre %>% 
    filter(basis %in% c("c02", "c03", "c05", "c07")) %>% 
    ggplot(aes(x = basis, y = value, fill = as.character(cluster))) +
    geom_violin() +
    scale_fill_viridis_d() +
    labs(x = 'Spotify Timbre Coefficients', y = '', fill = 'Cluster') + 
    facet_wrap(~basis, ncol=4, scales="free_x") +
    theme(axis.text.x=element_blank(), axis.ticks.x = element_blank()) + 
    ggtitle("")
```

***

I've plotted the three timbre features that varied the most across the different clusters, where c02 seems to have the most variance. With this plots, do keep in mind that all clusters have variable size. 

According to the spotify timbre documentation, c02 roughly correlates with the brightness. I'm inclined to believe that this correlation is inversed, ie higher c02 values implies a lower brightness. This is because the cluster with the lowest average brightness, cluster two, consists of two albums in which Rush uses a lot of brighter instruments (for instance, [these](https://open.spotify.com/playlist/35ps4GpYuPuAoiIG6kebAZ?si=dK4GyFCFT4GMZLmnJg7sZg) songs). This is in stark contrast to for instance cluster 4, that have an overall (though subjectively) darker tone (like [these](https://open.spotify.com/playlist/2btSbSR7hE9iHozoK4fG8V?si=2C2pIskmQh-WjFOP1QwiwQ)) 

This inverse correldasdation would also explain the fact that cluster 1 also have a lower c02 value on average. This cluster contains most of the early work of Rush (followed by cluster 2). The singer of Rush is known for a very high pitched voice, however his pitch has lowered through the years quite steeply.

Live vs. Studio
===

Column
---

### Plot

```{r livestudiochroma, echo=FALSE, eval=TRUE}
xanadu_st <- 
    get_tidy_audio_analysis('5q7KiSN7znIONR76LAqm7k') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)

xanadu_live <- 
    get_tidy_audio_analysis('3THzmYancb8RVehmqItO6G') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)

compmus_long_distance(
    xanadu_st %>% mutate(pitches = map(pitches, compmus_normalise, 'chebyshev')),
    xanadu_live %>% mutate(pitches = map(pitches, compmus_normalise, 'chebyshev')),
    feature = pitches,
    method = 'euclidean') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    scale_fill_continuous(type = 'viridis', guide = 'none') +
    labs(x = 'Xanadu Live', y = 'Xanadu Studio') +
    theme_minimal()
```

Column
---

### Description
Rush is well known for their live performances. To this end, I performed a chroma analysis between between the live and studio versions of one of Rush's most complex pieces: Xanadu. I tried to find a time alignment between these two editions, but as can be seen, there doesn't seem to exist one. The blue square at the bottom left must be the introduction; in this song the introduction consists largely of little percussive elements and not a clear stretch to speak of. What makes the time alignment even harder is that Rush sometimes like to speed up and slow down again, and of course, as is fairly common with rock bands, how they do that changes each performance. 

Genre analysis {.storyboard}
===

### First page

More to come :)
